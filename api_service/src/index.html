<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Task Manager - CAB432 Assignment 2</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        font-weight: 700;
      }

      .header p {
        opacity: 0.9;
        font-size: 1.1rem;
      }

      .main-content {
        padding: 30px;
      }

      .auth-section,
      .app-section {
        display: none;
      }

      .auth-section.active,
      .app-section.active {
        display: block;
      }

      .form-container {
        max-width: 400px;
        margin: 0 auto;
        background: #f8fafc;
        padding: 30px;
        border-radius: 10px;
        border: 1px solid #e2e8f0;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #374151;
      }

      .form-group input,
      .form-group textarea,
      .form-group select {
        width: 100%;
        padding: 12px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 16px;
        transition: all 0.3s ease;
      }

      .form-group input:focus,
      .form-group textarea:focus,
      .form-group select:focus {
        outline: none;
        border-color: #4f46e5;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
      }

      .btn {
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 100%;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .btn-secondary {
        background: #6b7280;
        margin-top: 10px;
      }

      .btn-danger {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      }

      .auth-tabs {
        display: flex;
        margin-bottom: 20px;
      }

      .auth-tab {
        flex: 1;
        padding: 15px;
        background: #e2e8f0;
        border: none;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .auth-tab.active {
        background: #4f46e5;
        color: white;
      }

      .auth-tab:first-child {
        border-radius: 8px 0 0 8px;
      }

      .auth-tab:last-child {
        border-radius: 0 8px 8px 0;
      }

      .user-info {
        background: #f0f9ff;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 30px;
        border-left: 4px solid #0ea5e9;
      }

      .user-info h3 {
        color: #0c4a6e;
        margin-bottom: 10px;
      }

      .tasks-container {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 30px;
        margin-top: 30px;
      }

      .task-form {
        background: #f8fafc;
        padding: 25px;
        border-radius: 10px;
        border: 1px solid #e2e8f0;
        height: fit-content;
      }

      .tasks-list {
        background: #f8fafc;
        padding: 25px;
        border-radius: 10px;
        border: 1px solid #e2e8f0;
      }

      .task-item {
        background: white;
        padding: 20px;
        margin-bottom: 15px;
        border-radius: 10px;
        border: 1px solid #e2e8f0;
        transition: all 0.3s ease;
        position: relative;
      }

      .task-item:hover {
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
      }

      .task-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 10px;
      }

      .task-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 5px;
      }

      .task-meta {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
      }

      .task-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .priority-high {
        background: #fee2e2;
        color: #dc2626;
      }

      .priority-medium {
        background: #fef3c7;
        color: #d97706;
      }

      .priority-low {
        background: #dcfce7;
        color: #16a34a;
      }

      .status-todo {
        background: #ede9fe;
        color: #7c3aed;
      }

      .status-inprogress {
        background: #dbeafe;
        color: #2563eb;
      }

      .status-completed {
        background: #dcfce7;
        color: #16a34a;
      }

      .task-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }

      .btn-small {
        padding: 6px 12px;
        font-size: 14px;
        width: auto;
      }

      .file-upload-section {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #e2e8f0;
      }

      .file-list {
        margin-top: 15px;
      }

      .file-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        background: #f1f5f9;
        border-radius: 6px;
        margin-bottom: 8px;
      }

      .alert {
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 8px;
        font-weight: 500;
      }

      .alert-success {
        background: #dcfce7;
        color: #166534;
        border: 1px solid #bbf7d0;
      }

      .alert-error {
        background: #fee2e2;
        color: #dc2626;
        border: 1px solid #fca5a5;
      }

      .alert-info {
        background: #dbeafe;
        color: #1e40af;
        border: 1px solid #93c5fd;
      }

      .loading {
        text-align: center;
        color: #6b7280;
        font-style: italic;
      }

      .websocket-status {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 10px 15px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        z-index: 1000;
      }

      .websocket-connected {
        background: #dcfce7;
        color: #16a34a;
      }

      .websocket-disconnected {
        background: #fee2e2;
        color: #dc2626;
      }

      .cache-indicator {
        font-size: 12px;
        color: #6b7280;
        margin-top: 10px;
        text-align: center;
      }

      @media (max-width: 768px) {
        .tasks-container {
          grid-template-columns: 1fr;
        }

        .container {
          margin: 10px;
          border-radius: 10px;
        }

        .main-content {
          padding: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>📋 Task Manager</h1>
        <p>CAB432 Assignment 2 - Cloud Services Demo</p>
      </div>

      <div class="main-content">
        <!-- Authentication Section -->
        <div class="auth-section active" id="authSection">
          <div class="form-container">
            <div class="auth-tabs">
              <button class="auth-tab active" onclick="switchAuthTab('login')">
                Login
              </button>
              <button class="auth-tab" onclick="switchAuthTab('register')">
                Register
              </button>
              <button class="auth-tab" onclick="switchAuthTab('confirm')">
                Confirm
              </button>
            </div>

            <div id="alertContainer"></div>

            <!-- Login Form -->
            <div id="loginForm" class="auth-form">
              <div class="form-group">
                <label for="loginUsername">Username:</label>
                <input
                  type="text"
                  id="loginUsername"
                  placeholder="Enter your username"
                />
              </div>
              <div class="form-group">
                <label for="loginPassword">Password:</label>
                <input
                  type="password"
                  id="loginPassword"
                  placeholder="Enter your password"
                />
              </div>
              <button class="btn" onclick="login()">Login</button>
            </div>

            <!-- Register Form -->
            <div id="registerForm" class="auth-form" style="display: none">
              <div class="form-group">
                <label for="registerUsername">Username:</label>
                <input
                  type="text"
                  id="registerUsername"
                  placeholder="Choose a username"
                />
              </div>
              <div class="form-group">
                <label for="registerEmail">Email:</label>
                <input
                  type="email"
                  id="registerEmail"
                  placeholder="Enter your email"
                />
              </div>
              <div class="form-group">
                <label for="registerPassword">Password:</label>
                <input
                  type="password"
                  id="registerPassword"
                  placeholder="Choose a strong password"
                />
              </div>
              <button class="btn" onclick="register()">Register</button>
            </div>

            <!-- Confirm Form -->
            <div id="confirmForm" class="auth-form" style="display: none">
              <div class="form-group">
                <label for="confirmUsername">Username:</label>
                <input
                  type="text"
                  id="confirmUsername"
                  placeholder="Enter your username"
                />
              </div>
              <div class="form-group">
                <label for="confirmationCode">Confirmation Code:</label>
                <input
                  type="text"
                  id="confirmationCode"
                  placeholder="Enter code from email"
                />
              </div>
              <button class="btn" onclick="confirmRegistration()">
                Confirm Email
              </button>
            </div>

            <div
              style="
                margin-top: 20px;
                padding: 15px;
                background: #f0f9ff;
                border-radius: 8px;
                font-size: 14px;
              "
            >
              <p><strong>Demo Credentials:</strong></p>
              <p>
                Create your own account or use test credentials if available
              </p>
            </div>
          </div>
        </div>

        <!-- Main App Section -->
        <div class="app-section" id="appSection">
          <div class="user-info" id="userInfo"></div>

          <div class="tasks-container">
            <!-- Task Creation Form -->
            <div class="task-form">
              <h3>Create New Task</h3>
              <div id="taskAlertContainer"></div>

              <div class="form-group">
                <label for="taskTitle">Title:</label>
                <input
                  type="text"
                  id="taskTitle"
                  placeholder="Enter task title"
                />
              </div>

              <div class="form-group">
                <label for="taskDescription">Description:</label>
                <textarea
                  id="taskDescription"
                  rows="4"
                  placeholder="Enter task description"
                ></textarea>
              </div>

              <div class="form-group">
                <label for="taskPriority">Priority:</label>
                <select id="taskPriority">
                  <option value="low">Low</option>
                  <option value="medium" selected>Medium</option>
                  <option value="high">High</option>
                </select>
              </div>

              <div class="form-group">
                <label for="taskStatus">Status:</label>
                <select id="taskStatus">
                  <option value="todo" selected>To Do</option>
                  <option value="inprogress">In Progress</option>
                  <option value="completed">Completed</option>
                </select>
              </div>

              <button class="btn" onclick="createTask()">Create Task</button>

              <!-- File Upload Section -->
              <div class="file-upload-section">
                <h4>Attach File</h4>
                <div class="form-group">
                  <label for="fileUpload">Choose File:</label>
                  <input type="file" id="fileUpload" />
                </div>
                <button class="btn btn-secondary" onclick="uploadFile()">
                  Upload File
                </button>

                <div class="file-list" id="fileList"></div>
              </div>

              <button
                class="btn btn-danger"
                onclick="logout()"
                style="margin-top: 30px"
              >
                Logout
              </button>
            </div>

            <!-- Tasks List -->
            <div class="tasks-list">
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 20px;
                "
              >
                <h3>Your Tasks</h3>
                <button class="btn btn-small" onclick="loadTasks()">
                  Refresh
                </button>
                <button
                  class="btn btn-small"
                  onclick="generateReport()"
                  class="btn"
                >
                  📊 Generate Task Report
                </button>
              </div>

              <div id="tasksContainer">
                <div class="loading">Loading tasks...</div>
              </div>

              <div class="cache-indicator" id="cacheIndicator"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- WebSocket Status Indicator -->
    <div class="websocket-status websocket-disconnected" id="websocketStatus">
      WebSocket: Disconnected
    </div>

    <script>
      // Configuration
      const API_BASE_URL = "http://54.253.199.219:3000"; // Change this to your domain
      let currentUser = null;
      let authToken = null;
      let websocket = null;
      let currentFiles = [];

      // Initialize app
      document.addEventListener("DOMContentLoaded", function () {
        // Check if user is already logged in
        const savedToken = localStorage.getItem("authToken");
        const savedUser = localStorage.getItem("currentUser");

        if (savedToken && savedUser) {
          authToken = savedToken;
          currentUser = JSON.parse(savedUser);
          showAppSection();
        }
      });

      // Utility functions
      function showAlert(message, type = "info", container = "alertContainer") {
        const alertDiv = document.createElement("div");
        alertDiv.className = `alert alert-${type}`;
        alertDiv.textContent = message;

        const containerEl = document.getElementById(container);
        containerEl.innerHTML = "";
        containerEl.appendChild(alertDiv);

        setTimeout(() => {
          if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
          }
        }, 5000);
      }
      async function generateReport() {
        try {
          const response = await makeApiRequest(
            "/api/reports/generate",
            "POST",
            {
              taskIds: "all",
              reportType: "summary",
            }
          );

          if (response.ok) {
            const data = await response.json();
            showAlert(
              `Report queued! Request ID: ${data.requestId}`,
              "success"
            );
            // Poll for completion or use WebSocket for notification
          }
        } catch (error) {
          showAlert("Failed to generate report", "error");
        }   
      }

      function makeApiRequest(endpoint, method = "GET", body = null) {
        const options = {
          method,
          headers: {
            "Content-Type": "application/json",
          },
        };

        if (authToken) {
          options.headers["Authorization"] = `Bearer ${authToken}`;
        }

        if (body) {
          options.body = JSON.stringify(body);
        }

        return fetch(`${API_BASE_URL}${endpoint}`, options);
      }

      // Authentication functions
      function switchAuthTab(tab) {
        // Update tabs
        document
          .querySelectorAll(".auth-tab")
          .forEach((t) => t.classList.remove("active"));
        event.target.classList.add("active");

        // Show correct form
        document
          .querySelectorAll(".auth-form")
          .forEach((f) => (f.style.display = "none"));
        document.getElementById(`${tab}Form`).style.display = "block";
      }

      async function register() {
        const username = document.getElementById("registerUsername").value;
        const email = document.getElementById("registerEmail").value;
        const password = document.getElementById("registerPassword").value;

        if (!username || !email || !password) {
          showAlert("Please fill in all fields", "error");
          return;
        }

        try {
          const response = await makeApiRequest("/api/auth/register", "POST", {
            username,
            email,
            password,
          });

          const data = await response.json();

          if (response.ok) {
            showAlert(
              "Registration successful! Check your email for confirmation code.",
              "success"
            );
            switchAuthTab("confirm");
            document.getElementById("confirmUsername").value = username;
          } else {
            showAlert(data.error || "Registration failed", "error");
          }
        } catch (error) {
          showAlert("Network error. Please check your connection.", "error");
        }
      }

      async function confirmRegistration() {
        const username = document.getElementById("confirmUsername").value;
        const confirmationCode =
          document.getElementById("confirmationCode").value;

        if (!username || !confirmationCode) {
          showAlert("Please fill in all fields", "error");
          return;
        }

        try {
          const response = await makeApiRequest("/api/auth/confirm", "POST", {
            username,
            confirmationCode,
          });

          const data = await response.json();

          if (response.ok) {
            showAlert("Email confirmed! You can now login.", "success");
            switchAuthTab("login");
            document.getElementById("loginUsername").value = username;
          } else {
            showAlert(data.error || "Confirmation failed", "error");
          }
        } catch (error) {
          showAlert("Network error. Please check your connection.", "error");
        }
      }

      async function login() {
        const username = document.getElementById("loginUsername").value;
        const password = document.getElementById("loginPassword").value;

        if (!username || !password) {
          showAlert("Please fill in all fields", "error");
          return;
        }

        try {
          const response = await makeApiRequest("/api/auth/login", "POST", {
            username,
            password,
          });

          const data = await response.json();

          if (response.ok) {
            authToken = data.accessToken;

            // Get user info
            const userResponse = await makeApiRequest("/api/auth/me");
            const userData = await userResponse.json();

            currentUser = userData.user;

            // Save to localStorage
            localStorage.setItem("authToken", authToken);
            localStorage.setItem("currentUser", JSON.stringify(currentUser));

            showAlert("Login successful!", "success");
            showAppSection();
          } else {
            showAlert(data.error || "Login failed", "error");
          }
        } catch (error) {
          showAlert("Network error. Please check your connection.", "error");
        }
      }

      function logout() {
        authToken = null;
        currentUser = null;
        localStorage.removeItem("authToken");
        localStorage.removeItem("currentUser");

        if (websocket) {
          websocket.close();
        }

        showAuthSection();
      }

      function showAuthSection() {
        document.getElementById("authSection").classList.add("active");
        document.getElementById("appSection").classList.remove("active");
      }

      function showAppSection() {
        document.getElementById("authSection").classList.remove("active");
        document.getElementById("appSection").classList.add("active");

        // Display user info
        document.getElementById("userInfo").innerHTML = `
                <h3>Welcome, ${currentUser.username}!</h3>
                <p><strong>Email:</strong> ${currentUser.email}</p>
                <p><strong>Groups:</strong> ${
                  currentUser.groups.join(", ") || "None"
                }</p>
                <p><strong>User ID:</strong> ${currentUser.userId}</p>
            `;

        // Load tasks and connect WebSocket
        loadTasks();
        connectWebSocket();
      }

      // Task management functions
      async function createTask() {
        const title = document.getElementById("taskTitle").value;
        const description = document.getElementById("taskDescription").value;
        const priority = document.getElementById("taskPriority").value;
        const status = document.getElementById("taskStatus").value;

        if (!title) {
          showAlert("Task title is required", "error", "taskAlertContainer");
          return;
        }

        try {
          const response = await makeApiRequest("/api/tasks", "POST", {
            title,
            description,
            priority,
            status,
          });

          const data = await response.json();

          if (response.ok) {
            showAlert(
              "Task created successfully!",
              "success",
              "taskAlertContainer"
            );

            // Clear form
            document.getElementById("taskTitle").value = "";
            document.getElementById("taskDescription").value = "";
            document.getElementById("taskPriority").value = "medium";
            document.getElementById("taskStatus").value = "todo";

            // Reload tasks
            loadTasks();
          } else {
            showAlert(
              data.error || "Failed to create task",
              "error",
              "taskAlertContainer"
            );
          }
        } catch (error) {
          showAlert(
            "Network error. Please check your connection.",
            "error",
            "taskAlertContainer"
          );
        }
      }

      async function loadTasks() {
        try {
          const response = await makeApiRequest("/api/tasks");
          const data = await response.json();

          if (response.ok) {
            displayTasks(data.tasks);

            // Show cache status
            const cacheStatus = data.cached
              ? "Loaded from cache ⚡"
              : "Loaded from database 💾";
            document.getElementById("cacheIndicator").textContent = cacheStatus;
          } else {
            showAlert("Failed to load tasks", "error", "taskAlertContainer");
          }
        } catch (error) {
          showAlert(
            "Network error. Please check your connection.",
            "error",
            "taskAlertContainer"
          );
        }
      }

      function displayTasks(tasks) {
        const container = document.getElementById("tasksContainer");

        if (!tasks || tasks.length === 0) {
          container.innerHTML =
            '<p class="loading">No tasks found. Create your first task!</p>';
          return;
        }

        container.innerHTML = tasks
          .map(
            (task) => `
                <div class="task-item" data-task-id="${task.taskId}">
                    <div class="task-header">
                        <div>
                            <div class="task-title">${task.title}</div>
                            <div class="task-meta">
                                <span class="task-badge priority-${
                                  task.priority
                                }">${task.priority}</span>
                                <span class="task-badge status-${
                                  task.status
                                }">${task.status.replace(
              "inprogress",
              "in progress"
            )}</span>
                            </div>
                        </div>
                    </div>
                    
                    ${
                      task.description
                        ? `<p style="margin-bottom: 10px; color: #6b7280;">${task.description}</p>`
                        : ""
                    }
                    
                    <div style="font-size: 12px; color: #9ca3af; margin-bottom: 10px;">
                        Created: ${new Date(
                          task.createdAt
                        ).toLocaleDateString()}
                        ${
                          task.updatedAt !== task.createdAt
                            ? ` • Updated: ${new Date(
                                task.updatedAt
                              ).toLocaleDateString()}`
                            : ""
                        }
                    </div>
                    
                    <div class="task-actions">
                        <button class="btn btn-small" onclick="updateTaskStatus('${
                          task.taskId
                        }', '${
              task.status === "completed" ? "todo" : "completed"
            }')">
                            ${
                              task.status === "completed"
                                ? "Mark Incomplete"
                                : "Mark Complete"
                            }
                        </button>
                        <button class="btn btn-small btn-danger" onclick="deleteTask('${
                          task.taskId
                        }')">Delete</button>
                    </div>
                </div>
            `
          )
          .join("");
      }

      async function updateTaskStatus(taskId, newStatus) {
        try {
          const response = await makeApiRequest(`/api/tasks/${taskId}`, "PUT", {
            status: newStatus,
          });

          if (response.ok) {
            showAlert(
              "Task updated successfully!",
              "success",
              "taskAlertContainer"
            );
            loadTasks();
          } else {
            showAlert("Failed to update task", "error", "taskAlertContainer");
          }
        } catch (error) {
          showAlert(
            "Network error. Please check your connection.",
            "error",
            "taskAlertContainer"
          );
        }
      }

      async function deleteTask(taskId) {
        if (!confirm("Are you sure you want to delete this task?")) {
          return;
        }

        try {
          const response = await makeApiRequest(
            `/api/tasks/${taskId}`,
            "DELETE"
          );

          if (response.ok) {
            showAlert(
              "Task deleted successfully!",
              "success",
              "taskAlertContainer"
            );
            loadTasks();
          } else {
            showAlert("Failed to delete task", "error", "taskAlertContainer");
          }
        } catch (error) {
          showAlert(
            "Network error. Please check your connection.",
            "error",
            "taskAlertContainer"
          );
        }
      }

      // File upload functions
      async function uploadFile() {
        const fileInput = document.getElementById("fileUpload");
        const file = fileInput.files[0];

        if (!file) {
          showAlert(
            "Please select a file first",
            "error",
            "taskAlertContainer"
          );
          return;
        }

        try {
          // Get pre-signed upload URL
          const response = await makeApiRequest(
            "/api/files/upload-url",
            "POST",
            {
              fileName: file.name,
              contentType: file.type,
              taskId: "general",
            }
          );

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.error);
          }

          // Upload file directly to S3
          const uploadResponse = await fetch(data.uploadUrl, {
            method: "PUT",
            body: file,
            headers: {
              "Content-Type": file.type,
            },
          });

          if (uploadResponse.ok) {
            showAlert(
              "File uploaded successfully!",
              "success",
              "taskAlertContainer"
            );
            currentFiles.push({
              key: data.fileKey,
              name: file.name,
              size: file.size,
            });
            updateFileList();
            fileInput.value = "";
          } else {
            throw new Error("Failed to upload to S3");
          }
        } catch (error) {
          showAlert(
            `Upload failed: ${error.message}`,
            "error",
            "taskAlertContainer"
          );
        }
      }

      function updateFileList() {
        const fileList = document.getElementById("fileList");

        if (currentFiles.length === 0) {
          fileList.innerHTML =
            '<p style="color: #6b7280; font-style: italic;">No files uploaded yet</p>';
          return;
        }

        fileList.innerHTML = currentFiles
          .map(
            (file, index) => `
                <div class="file-item">
                    <div>
                        <strong>${file.name}</strong>
                        <span style="color: #6b7280; font-size: 12px;">(${formatFileSize(
                          file.size
                        )})</span>
                    </div>
                    <div>
                        <button class="btn btn-small" onclick="downloadFile('${
                          file.key
                        }', '${file.name}')">Download</button>
                        <button class="btn btn-small btn-danger" onclick="deleteFile('${
                          file.key
                        }', ${index})">Delete</button>
                    </div>
                </div>
            `
          )
          .join("");
      }

      async function downloadFile(fileKey, fileName) {
        try {
          const response = await makeApiRequest(
            "/api/files/download-url",
            "POST",
            {
              fileKey: fileKey,
            }
          );

          const data = await response.json();

          if (response.ok) {
            // Open download URL in new tab
            const link = document.createElement("a");
            link.href = data.downloadUrl;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          } else {
            showAlert(
              "Failed to get download URL",
              "error",
              "taskAlertContainer"
            );
          }
        } catch (error) {
          showAlert("Download failed", "error", "taskAlertContainer");
        }
      }

      async function deleteFile(fileKey, index) {
        if (!confirm("Are you sure you want to delete this file?")) {
          return;
        }

        try {
          const response = await makeApiRequest(
            `/api/files/${encodeURIComponent(fileKey)}`,
            "DELETE"
          );

          if (response.ok) {
            showAlert(
              "File deleted successfully!",
              "success",
              "taskAlertContainer"
            );
            currentFiles.splice(index, 1);
            updateFileList();
          } else {
            showAlert("Failed to delete file", "error", "taskAlertContainer");
          }
        } catch (error) {
          showAlert("Delete failed", "error", "taskAlertContainer");
        }
      }

      function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      // WebSocket functions
      function connectWebSocket() {
        if (!currentUser) return;

        const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
        const wsUrl = `${protocol}//${window.location.hostname}:3000/api/notifications`;

        websocket = new WebSocket(wsUrl);

        websocket.onopen = function () {
          console.log("WebSocket connected");
          updateWebSocketStatus(true);

          // Subscribe to notifications
          websocket.send(
            JSON.stringify({
              type: "subscribe",
              userId: currentUser.userId,
            })
          );
        };

        websocket.onmessage = function (event) {
          try {
            const data = JSON.parse(event.data);
            console.log("WebSocket message:", data);

            if (data.type === "notification") {
              showAlert(
                `Notification: ${data.message}`,
                "info",
                "taskAlertContainer"
              );
            }
          } catch (error) {
            console.error("WebSocket message parse error:", error);
          }
        };

        websocket.onclose = function () {
          console.log("WebSocket disconnected");
          updateWebSocketStatus(false);

          // Attempt to reconnect after 5 seconds
          setTimeout(() => {
            if (currentUser) {
              console.log("Attempting to reconnect WebSocket...");
              connectWebSocket();
            }
          }, 5000);
        };

        websocket.onerror = function (error) {
          console.error("WebSocket error:", error);
          updateWebSocketStatus(false);
        };
      }

      function updateWebSocketStatus(connected) {
        const statusEl = document.getElementById("websocketStatus");
        if (connected) {
          statusEl.textContent = "WebSocket: Connected";
          statusEl.className = "websocket-status websocket-connected";
        } else {
          statusEl.textContent = "WebSocket: Disconnected";
          statusEl.className = "websocket-status websocket-disconnected";
        }
      }

      // Demo functions for testing
      function runDemo() {
        showAlert(
          "Demo mode: This will create sample tasks and files",
          "info",
          "taskAlertContainer"
        );

        // Create sample tasks
        setTimeout(() => {
          document.getElementById("taskTitle").value = "Demo Task 1";
          document.getElementById("taskDescription").value =
            "This is a demo task to show DynamoDB integration";
          document.getElementById("taskPriority").value = "high";
          createTask();
        }, 1000);

        setTimeout(() => {
          document.getElementById("taskTitle").value = "Demo Task 2";
          document.getElementById("taskDescription").value =
            "This task demonstrates caching functionality";
          document.getElementById("taskPriority").value = "medium";
          createTask();
        }, 2000);
      }

      // Add demo button and API URL configuration
      function showApiConfig() {
        const currentUrl = document.getElementById("apiUrl")
          ? document.getElementById("apiUrl").value
          : API_BASE_URL;
        const newUrl = prompt(
          "Enter your API URL (e.g., http://n1234567-tasks.cab432.com:3000):",
          currentUrl
        );

        if (newUrl && newUrl !== currentUrl) {
          // Update the API base URL
          window.API_BASE_URL = newUrl.replace(/\/$/, ""); // Remove trailing slash

          // Show confirmation
          showAlert(`API URL updated to: ${window.API_BASE_URL}`, "success");

          // Add input field to remember URL
          if (!document.getElementById("apiUrl")) {
            const configDiv = document.createElement("div");
            configDiv.innerHTML = `
                        <div style="margin: 20px 0; padding: 15px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <label for="apiUrl" style="font-weight: 600; margin-bottom: 8px; display: block;">API URL:</label>
                            <input type="text" id="apiUrl" value="${window.API_BASE_URL}" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                            <button onclick="showApiConfig()" style="margin-top: 8px; padding: 6px 12px; background: #4f46e5; color: white; border: none; border-radius: 4px; cursor: pointer;">Update URL</button>
                        </div>
                    `;
            document
              .querySelector(".form-container")
              .insertBefore(configDiv, document.querySelector(".auth-tabs"));
          } else {
            document.getElementById("apiUrl").value = window.API_BASE_URL;
          }
        }
      }

      // Override the makeApiRequest function to use dynamic URL
      const originalMakeApiRequest = makeApiRequest;
      makeApiRequest = function (endpoint, method = "GET", body = null) {
        const baseUrl = window.API_BASE_URL || API_BASE_URL;
        const options = {
          method,
          headers: {
            "Content-Type": "application/json",
          },
        };

        if (authToken) {
          options.headers["Authorization"] = `Bearer ${authToken}`;
        }

        if (body) {
          options.body = JSON.stringify(body);
        }

        return fetch(`${baseUrl}${endpoint}`, options);
      };

      // Add configuration button when page loads
      document.addEventListener("DOMContentLoaded", function () {
        // Add API config button to auth section
        const authContainer = document.querySelector(".form-container");
        const configButton = document.createElement("button");
        configButton.textContent = "⚙️ Configure API URL";
        configButton.className = "btn btn-secondary";
        configButton.style.marginTop = "10px";
        configButton.onclick = showApiConfig;

        // Insert before demo credentials
        const demoDiv = authContainer.querySelector('div[style*="demo"]');
        if (demoDiv) {
          authContainer.insertBefore(configButton, demoDiv);
        } else {
          authContainer.appendChild(configButton);
        }

        // Add demo button to app section
        const taskForm = document.querySelector(".task-form");
        const demoButton = document.createElement("button");
        demoButton.textContent = "🚀 Run Demo";
        demoButton.className = "btn btn-secondary";
        demoButton.style.marginTop = "10px";
        demoButton.onclick = runDemo;

        const logoutButton = taskForm.querySelector(".btn-danger");
        taskForm.insertBefore(demoButton, logoutButton);
      });

      // Health check function
      async function checkHealth() {
        try {
          const baseUrl = window.API_BASE_URL || API_BASE_URL;
          const response = await fetch(`${baseUrl}/health`);
          const data = await response.json();

          if (response.ok) {
            showAlert(
              `✅ API Health Check: ${data.status} (${data.timestamp})`,
              "success"
            );
          } else {
            showAlert("❌ API Health Check: Failed", "error");
          }
        } catch (error) {
          showAlert("❌ API Health Check: Connection failed", "error");
        }
      }
    </script>
  </body>
</html>
